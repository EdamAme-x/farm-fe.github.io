"use strict";(self.webpackChunkfarm_docs=self.webpackChunkfarm_docs||[]).push([[6019],{9613:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>h});var a=n(9496);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var c=a.createContext({}),p=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},s=function(e){var t=p(e.components);return a.createElement(c.Provider,{value:t},e.children)},d="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,c=e.parentName,s=o(e,["components","mdxType","originalType","parentName"]),d=p(n),u=i,h=d["".concat(c,".").concat(u)]||d[u]||m[u]||r;return n?a.createElement(h,l(l({ref:t},s),{},{components:n})):a.createElement(h,l({ref:t},s))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,l=new Array(r);l[0]=u;var o={};for(var c in t)hasOwnProperty.call(t,c)&&(o[c]=t[c]);o.originalType=e,o[d]="string"==typeof e?e:i,l[1]=o;for(var p=2;p<r;p++)l[p]=n[p];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},1770:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>m,frontMatter:()=>r,metadata:()=>o,toc:()=>p});var a=n(1163),i=(n(9496),n(9613));const r={},l="Persistent Cache",o={unversionedId:"features/persistent-cache",id:"features/persistent-cache",title:"Persistent Cache",description:"Farm supports persistent cache since v0.14.0",source:"@site/docs/features/persistent-cache.md",sourceDirName:"features",slug:"/features/persistent-cache",permalink:"/zh/docs/features/persistent-cache",draft:!1,editUrl:"https://github.com/farm-fe/farm-fe.github.io/tree/main/docs/features/persistent-cache.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"\u8bed\u6cd5\u964d\u7ea7\u548c Polyfill",permalink:"/zh/docs/features/polyfill"},next:{title:"Benchmarks",permalink:"/zh/docs/benchmark"}},c={},p=[{value:"Using Cache",id:"using-cache",level:2},{value:"Cache Validation",id:"cache-validation",level:2},{value:"Build Dependencies",id:"build-dependencies",level:2},{value:"Module Cache Key Strategy",id:"module-cache-key-strategy",level:2},{value:"Caveats For Plugins",id:"caveats-for-plugins",level:2}],s={toc:p},d="wrapper";function m(e){let{components:t,...n}=e;return(0,i.kt)(d,(0,a.Z)({},s,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"persistent-cache"},"Persistent Cache"),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Farm supports persistent cache since ",(0,i.kt)("inlineCode",{parentName:"p"},"v0.14.0"))),(0,i.kt)("p",null,"Since ",(0,i.kt)("inlineCode",{parentName:"p"},"v0.14.0"),", Farm supports cache the compiled result to disk, which can greatly speed up the compilation for hot start/hot build. When ",(0,i.kt)("inlineCode",{parentName:"p"},"persistentCache")," is enabled, the compilation time can reduce ",(0,i.kt)("strong",{parentName:"p"},"up to ",(0,i.kt)("inlineCode",{parentName:"strong"},"80%")),"."),(0,i.kt)("p",null,"Performance compare between cold start(without cache) and hot start(with cache) using ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/farm-fe/farm/tree/main/examples/arco-pro"},"examples/argo-pro"),":"),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null}),(0,i.kt)("th",{parentName:"tr",align:null},"Cold(without cache)"),(0,i.kt)("th",{parentName:"tr",align:null},"Hot(with cache)"),(0,i.kt)("th",{parentName:"tr",align:null},"diff"))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"start"),(0,i.kt)("td",{parentName:"tr",align:null},"1504ms"),(0,i.kt)("td",{parentName:"tr",align:null},"473ms"),(0,i.kt)("td",{parentName:"tr",align:null},"compile time reduced 68%")),(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},"build"),(0,i.kt)("td",{parentName:"tr",align:null},"3092"),(0,i.kt)("td",{parentName:"tr",align:null}),(0,i.kt)("td",{parentName:"tr",align:null})))),(0,i.kt)("h2",{id:"using-cache"},"Using Cache"),(0,i.kt)("p",null,"Using ",(0,i.kt)("inlineCode",{parentName:"p"},"compilation.persistentCache")," to enable/disable Cache:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"import { defineConfig } from '@farmfe/core';\n\nexport default defineConfig({\n  compilation: {\n    persistentCache: true\n  }\n})\n")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("inlineCode",{parentName:"p"},"persistentCache: true")," is equal to:"),(0,i.kt)("pre",{parentName:"admonition"},(0,i.kt)("code",{parentName:"pre",className:"language-js"},"({\n  persistentCache: {\n    // Directory that cache is stored\n    cacheDir: 'node_modules/.farm/cache',\n    // namespace of the cache\n    namespace: 'farm-cache',\n    buildDependencies: [\n      'farm.config.ts',\n      '@farmfe/core',\n      '@farmfe/plugin-react'\n      // ... all other dependencies\n    ],\n    moduleCacheKeyStrategy: {\n      timestamp: true,\n      hash: true,\n    }\n  }\n})\n"))),(0,i.kt)("p",null,"Configuring ",(0,i.kt)("inlineCode",{parentName:"p"},"persistentCache")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"false")," to disable cache."),(0,i.kt)("h2",{id:"cache-validation"},"Cache Validation"),(0,i.kt)("p",null,"Cache will be validated when trying to reuse it by following conditions, if any of following conditions changed, all cache will be invalidated:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Final Config Object"),": the final config object after calling plugins' config hook, if the object changed, for example, the config file changed or some env variables that affect the compilation changed, all cache will be invalidated."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Build Dependencies"),": configured by ",(0,i.kt)("inlineCode",{parentName:"li"},"persistentCache.buildDependencies"),", if any of the buildDependencies changed, all cache will be invalidated."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Cache Namespace"),": configured by ",(0,i.kt)("inlineCode",{parentName:"li"},"persistentCache.namespace"),", cache under different namespaces won't be reused. If you want to invalidate all cache, you can configure a different namespace."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"Internal Cache Version"),": Farm maintains a cache version internally, if Farm itself changed, for example, render optimization that affects the output between versions of Farm, Farm will bump the cache version and all cache will be invalidated.")),(0,i.kt)("p",null,"If you cache does not work for some reasons, checkout above conditions to figure out the reason. You can also delete ",(0,i.kt)("inlineCode",{parentName:"p"},"node_modules/.farm/cache")," to remove cache manually."),(0,i.kt)("h2",{id:"build-dependencies"},"Build Dependencies"),(0,i.kt)("p",null,"Build dependencies is dependencies that can affect the compilation process or compiled output, for examples, plugins or config files. If any of these dependencies changed, all cache will be invalidated."),(0,i.kt)("p",null,"Build dependencies can be a file path for a package name, for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts"},"import { defineConfig } from '@farmfe/core';\nimport path from 'node:path';\n\nexport default defineConfig({\n  persistentCache: {\n    buildDependencies: [\n      // a file path\n      path.resolve(process.cwd(), './plugins/my-plugin.js'),\n      // a package name, note that this package must expose package.json\n      'farm-plugin-custom-xxx'\n    ]\n  }\n})\n")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"By default, all config files and its dependencies are included. But if you want to add some additional files or dependencies to invalidate the cache, you can using ",(0,i.kt)("inlineCode",{parentName:"p"},"buildDependencies")," once these files changed, all cache will be invalidated.")),(0,i.kt)("h2",{id:"module-cache-key-strategy"},"Module Cache Key Strategy"),(0,i.kt)("p",null,"Farm provides 2 strategies to control how to generate module cache key:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"timestamp"),": whether check timestamp of the module, if the update timestamp does not change, the build of this module will be skipped, which has the best performance."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"hash"),": whether check content hash after load and transform, if the content does not change, the left build of this module will be skipped.")),(0,i.kt)("p",null,"By default ",(0,i.kt)("inlineCode",{parentName:"p"},"timestamp")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"hash")," are both enabled."),(0,i.kt)("h2",{id:"caveats-for-plugins"},"Caveats For Plugins"),(0,i.kt)("p",null,"when ",(0,i.kt)("inlineCode",{parentName:"p"},"timestamp")," is enabled, all build stages hooks like ",(0,i.kt)("inlineCode",{parentName:"p"},"load")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"transform")," won't be called. So if the plugin relies ",(0,i.kt)("inlineCode",{parentName:"p"},"load")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"transform")," and it does not implement ",(0,i.kt)("inlineCode",{parentName:"p"},"plugin_cache_loaded")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"write_plugin_cache")," hook, it may not work as expected. For example, if a plugin collect information in ",(0,i.kt)("inlineCode",{parentName:"p"},"load")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"transform"),", all emit them at ",(0,i.kt)("inlineCode",{parentName:"p"},"finish")," hook, it should implement ",(0,i.kt)("inlineCode",{parentName:"p"},"plugin_cache_loaded")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"write_plugin_cache")," hook to load and write cache, otherwise it will not work as expected."),(0,i.kt)("p",null,"Farm will set ",(0,i.kt)("inlineCode",{parentName:"p"},"timestamp")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"false")," when ",(0,i.kt)("inlineCode",{parentName:"p"},"output.targetEnv")," is ",(0,i.kt)("inlineCode",{parentName:"p"},"node"),". "))}m.isMDXComponent=!0}}]);