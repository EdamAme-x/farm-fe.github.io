"use strict";(self.webpackChunkfarm_docs=self.webpackChunkfarm_docs||[]).push([[1661],{9613:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>g});var a=n(9496);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),u=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=u(e.components);return a.createElement(s.Provider,{value:t},e.children)},m="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,s=e.parentName,d=o(e,["components","mdxType","originalType","parentName"]),m=u(n),c=i,g=m["".concat(s,".").concat(c)]||m[c]||p[c]||r;return n?a.createElement(g,l(l({ref:t},d),{},{components:n})):a.createElement(g,l({ref:t},d))}));function g(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,l=new Array(r);l[0]=c;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o[m]="string"==typeof e?e:i,l[1]=o;for(var u=2;u<r;u++)l[u]=n[u];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},2949:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>o,toc:()=>u});var a=n(1163),i=(n(9496),n(9613));const r={},l="Partial Bundling",o={unversionedId:"features/partial-bundling",id:"features/partial-bundling",title:"Partial Bundling",description:"Partial Bundling is a strategy that Farm uses to bundle modules, similar to what other bundlers do but the goal of Farm's Partial Bundling is different.",source:"@site/docs/features/partial-bundling.md",sourceDirName:"features",slug:"/features/partial-bundling",permalink:"/docs/features/partial-bundling",draft:!1,editUrl:"https://github.com/farm-fe/farm-fe.github.io/tree/main/docs/features/partial-bundling.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Lazy Compilation",permalink:"/docs/features/lazy-compilation"},next:{title:"Source Map",permalink:"/docs/features/sourcemap"}},s={},u=[{value:"Motivation",id:"motivation",level:2},{value:"Partial Bundling Rules",id:"partial-bundling-rules",level:2},{value:"Configuring Partial Bundling",id:"configuring-partial-bundling",level:2},{value:"Grouping Modules",id:"grouping-modules",level:3},{value:"Using <code>enforceResources</code>",id:"using-enforceresources",level:3},{value:"Configuring <code>immutable modules</code>",id:"configuring-immutable-modules",level:3}],d={toc:u},m="wrapper";function p(e){let{components:t,...n}=e;return(0,i.kt)(m,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"partial-bundling"},"Partial Bundling"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Partial Bundling")," is a strategy that Farm uses to bundle modules, similar to what other bundlers do but the goal of Farm's ",(0,i.kt)("inlineCode",{parentName:"p"},"Partial Bundling")," is different."),(0,i.kt)("p",null,"Unlike other bundlers, Farm will not trying to bundle everything together and then split them out using optimizations like ",(0,i.kt)("inlineCode",{parentName:"p"},"splitChunks"),", on the opposite, Farm will bundle projects into several output files directly. For example, if there are hundreds of modules needed to launch a html page, Farm will try to bundle them into 20-30 output files directly. Farm calls this behavior ",(0,i.kt)("inlineCode",{parentName:"p"},"Partial Bundling"),"."),(0,i.kt)("p",null,"Farm's goal of Partial Bundling is to:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Reduce request numbers and request hierarchy"),": Make hundreds or thousands of module requests reduce to 20-30 requests, and avoid loading modules one after one due to dependency hierarchy, which would make resource loading faster."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Increase cache hit rate"),": When a modules changed, makes sure that only a few output files are affected, so more cache can be used for a online project.")),(0,i.kt)("p",null,"For traditional bundlers, we may have a hard time to configure complex ",(0,i.kt)("inlineCode",{parentName:"p"},"splitChunks")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"manualChunks")," to achieve the goal above, but in Farm, it is supported natively through ",(0,i.kt)("inlineCode",{parentName:"p"},"Partial Bundling"),"."),(0,i.kt)("admonition",{type:"tip"},(0,i.kt)("p",{parentName:"admonition"},"Refer to ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/farm-fe/rfcs/blob/main/rfcs/003-partial-bundling/rfc.md"},"RFC-003 Partial Bundling")," to get more technical details.")),(0,i.kt)("h2",{id:"motivation"},"Motivation"),(0,i.kt)("p",null,"There are two main methods of handling modules in web build tools now: Bundling or native ESM. But they both have drawbacks:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"For bundling, bundlers aim to bundle everything together and then split them out for optimization, but splitting is often hard to configure and is hard to balance resources loading performance and cache hit rate manually. "),(0,i.kt)("li",{parentName:"ul"},"For native esm, every module can be compiled, cached separately, but the load performance are heavily affected when there are hundreds of module requests.")),(0,i.kt)("p",null,"So I was always thinking that if there is a strategy to avoid these two extremes - maybe we can do partial bundling? we can just bundle the project into several limited, size balanced resources directly and automatically. I named this thinking ",(0,i.kt)("inlineCode",{parentName:"p"},"Module Merging")," - Find a balance between bundle and unbundled, only bundles a few related modules to improve loading performance without losing cache granularity."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"I renamed ",(0,i.kt)("inlineCode",{parentName:"p"},"Module Merging")," to ",(0,i.kt)("inlineCode",{parentName:"p"},"Partial Bundling")," later because I think ",(0,i.kt)("inlineCode",{parentName:"p"},"Partial Bundling")," can expresses more accurately what I was thinking.")),(0,i.kt)("h2",{id:"partial-bundling-rules"},"Partial Bundling Rules"),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"In this section, we will introduce the basic rules that ",(0,i.kt)("inlineCode",{parentName:"p"},"Partial Bundling")," uses by examples.")),(0,i.kt)("p",null,"First we look into a basic react project example. For a basic react project like below, we only import react and react-dom in the entry script:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-tsx",metastring:'title="index.tsx"',title:'"index.tsx"'},"import React from 'react';\nimport { createRoot } from 'react-dom/client';\nimport './index.scss';\n\nconst container = document.querySelector('#root');\nconst root = createRoot(container);\n\nroot.render(\n  <>\n    <div>Index page</div>\n  </>\n);\n")),(0,i.kt)("p",null,"The bundling result will looks like:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-text"},"./dist/\n\u251c\u2500\u2500 index_9c07.49b83356.js      # contains react-dom\n\u251c\u2500\u2500 index_a35f.0ac21082.js      # contains ./index.tsx\n\u251c\u2500\u2500 index_b7e0.7ab9ca2d.js      # contains react and its dependencies\n\u251c\u2500\u2500 index_ce26.7f833381.css     $ contains ./index.scss\n\u2514\u2500\u2500 index.html                  # contains ./index.html\n")),(0,i.kt)("p",null,"Farm will bundle your project into 5 files by default:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"2 js files")," are from ",(0,i.kt)("inlineCode",{parentName:"li"},"node_modules")," and contains ",(0,i.kt)("inlineCode",{parentName:"li"},"react"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"react-dom")," and their dependencies."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"1 js file")," are from ",(0,i.kt)("inlineCode",{parentName:"li"},"./index.tsx")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"1 css file")," are from ",(0,i.kt)("inlineCode",{parentName:"li"},"./index.scss"),";"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"1 html file")," are from ",(0,i.kt)("inlineCode",{parentName:"li"},"./index.html"),";")),(0,i.kt)("p",null,"Farm uses following rules to get above results:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Mutable and immutable modules should always be in different output files"),": By default Farm treat all modules under ",(0,i.kt)("inlineCode",{parentName:"li"},"node_modules")," are immutable, otherwise they are mutable. So ",(0,i.kt)("inlineCode",{parentName:"li"},"./index.tsx")," is in a separate file cause it's a mutable module, so it never be in the same output file with ",(0,i.kt)("inlineCode",{parentName:"li"},"react")," and ",(0,i.kt)("inlineCode",{parentName:"li"},"react-dom"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Different type of module are always in different output files"),": So ",(0,i.kt)("inlineCode",{parentName:"li"},"./index.scss")," are in a separate file."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Modules in the same package should be in the same output file"),": So all ",(0,i.kt)("inlineCode",{parentName:"li"},"react")," modules are always in the same output file, so does ",(0,i.kt)("inlineCode",{parentName:"li"},"react-dom"),"."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"The target concurrent requests for a resource loading should be between 20-30 by default"),": So there are 3 js output files instead of 1 js bundles."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},"Output files should be of similar size and min resource size should be greater than 20KB by default"),": Because ",(0,i.kt)("inlineCode",{parentName:"li"},"react-dom")," is the largest and more than 100KB, it is in a separate file, and ",(0,i.kt)("inlineCode",{parentName:"li"},"react")," and its dependencies are smaller than ",(0,i.kt)("inlineCode",{parentName:"li"},"20KB"),", there are merged into the same output file.")),(0,i.kt)("p",null,"Now we have familiar with ",(0,i.kt)("inlineCode",{parentName:"p"},"Partial Bundling"),"'s basic rules, if met problems with partial bundling, using above rules to debug your project. Next we'll cover how to configure partial bundling."),(0,i.kt)("h2",{id:"configuring-partial-bundling"},"Configuring Partial Bundling"),(0,i.kt)("p",null,(0,i.kt)("inlineCode",{parentName:"p"},"Partial Bundling")," supports a lot of options to let users customize its behavior. All the options are as below:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"targetConcurrentRequests")),": Farm tries to generate resource numbers as closer as possible to this config value for initial resource loading or a dynamic resource loading."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"targetMinSize")),": The minimum size of generated resources before minify and gzip. Note that ",(0,i.kt)("inlineCode",{parentName:"li"},"targetMinSize")," will not be satisfied if ",(0,i.kt)("inlineCode",{parentName:"li"},"ModuleBucket's size")," is less than ",(0,i.kt)("inlineCode",{parentName:"li"},"targetMinSize"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"ModuleBucket")," will be given priority. Config ",(0,i.kt)("inlineCode",{parentName:"li"},"enforceTargetMinSize")," can be used to enforce size."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"targetMaxSize")),": The maximum size of generated resources before minify and gzip."),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"groups")),": A group of modules that should be placed together. Note that this group config is only a hit to the compiler that these modules should be placed together, it may produce multiple resources, if you want to enforce modules in the same resource, you should use ",(0,i.kt)("inlineCode",{parentName:"li"},"enforceResources"),".",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"name"),": Name of this group."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"test"),": Regex array to match the modules which are in this group."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"groupType"),": ",(0,i.kt)("inlineCode",{parentName:"li"},"mutable")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"immutable"),", this group only applies to the specified type of modules."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"resourceType"),": ",(0,i.kt)("inlineCode",{parentName:"li"},"all"),", ",(0,i.kt)("inlineCode",{parentName:"li"},"initial")," or ",(0,i.kt)("inlineCode",{parentName:"li"},"async"),", this group only applies to the specified type of resources."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"enforceResources")),": Array to match the modules that should always be in the same output resource, ignore all other constraints.",(0,i.kt)("ul",{parentName:"li"},(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"name"),": Name of this resource."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("strong",{parentName:"li"},"test"),": Regex array to match the modules which are in this resource."))),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"enforceTargetConcurrentRequests")),": Enforce target concurrent requests for every resource loading, when true, smaller resource will be merged into bigger resource to meet the target concurrent requests. this may cause issue for css resource, be careful to use this option"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"enforceTargetMinSize")),": Enforce target min size for every resource, when true, smaller resource will be merged into bigger resource to meet the target concurrent requests. this may cause issue for css resource, be careful to use this option"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"immutableModules")),": Regex array to match the immutable modules"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("strong",{parentName:"li"},(0,i.kt)("inlineCode",{parentName:"strong"},"immutableModulesWeight")),": Default to ",(0,i.kt)("inlineCode",{parentName:"li"},"0.8"),", immutable module will have 80% request numbers. For example, if ",(0,i.kt)("inlineCode",{parentName:"li"},"targetConcurrentRequest")," is 25, then immutable resources will take ",(0,i.kt)("inlineCode",{parentName:"li"},"25 * 80% = 20")," by default. This option is to make sure that mutable and immutable modules are isolate, if change your business code, code under node_modules won't be affected.")),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"In general, you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"targetConcurrentRequests"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"targetMinSize")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"targetMaxSize")," to control the default behavior of Partial Bundling. The default value set by Farm is based on best practice, so make sure it's necessary when you want to change the default value.")),(0,i.kt)("h3",{id:"grouping-modules"},"Grouping Modules"),(0,i.kt)("p",null,"you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"groups")," to group modules together, for above basic react project example, using following configuration to make modules under ",(0,i.kt)("inlineCode",{parentName:"p"},"node_modules")," are bundled together:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="farm.config.ts" {4-9}',title:'"farm.config.ts"',"{4-9}":!0},"export default defineConfig({\n  compilation: {\n    partialBundling: {\n      groups: [\n        {\n          name: 'vendor-react',\n          test: ['node_modules/'],\n        }\n      ]\n    },\n  },\n});\n")),(0,i.kt)("p",null,"we add a ",(0,i.kt)("inlineCode",{parentName:"p"},"group item")," with ",(0,i.kt)("inlineCode",{parentName:"p"},"name")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"test")," to group ",(0,i.kt)("inlineCode",{parentName:"p"},"react")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"react-dom")," together. The bundle result is:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"./dist/\n\u251c\u2500\u2500 index_499e.72cf733c.js    # contains `react`, `react-dom` and all other files under node_modules\n\u251c\u2500\u2500 index_a35f.0ac21082.js    # contains `./index.tsx`\n\u251c\u2500\u2500 index_ce26.7f833381.css   # contains `./index.scss`\n\u2514\u2500\u2500 index.html                # contains `./index.html`\n")),(0,i.kt)("p",null,"Now all modules under ",(0,i.kt)("inlineCode",{parentName:"p"},"node_modules")," are bundled into ",(0,i.kt)("inlineCode",{parentName:"p"},"index_499e.72cf733c.js"),". Note that ",(0,i.kt)("inlineCode",{parentName:"p"},"groups")," is not not enforce that all modules matches this group are bundled, a ",(0,i.kt)("inlineCode",{parentName:"p"},"group")," make produce multiple ",(0,i.kt)("inlineCode",{parentName:"p"},"output file"),", because:"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"mutable and immutable module are always in different output files. When both mutable and immutable modules hit this ",(0,i.kt)("inlineCode",{parentName:"li"},"group"),", they will be in different output."),(0,i.kt)("li",{parentName:"ol"},"when comes to a multi page app or dynamic imported entries, there may be shared modules, and these should modules are always in different output files.")),(0,i.kt)("p",null,"If you need to enforce modules in the same output files, you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"enforceResources")),(0,i.kt)("h3",{id:"using-enforceresources"},"Using ",(0,i.kt)("inlineCode",{parentName:"h3"},"enforceResources")),(0,i.kt)("p",null,"To group all modules together and ignore all other conditions, you can use ",(0,i.kt)("inlineCode",{parentName:"p"},"enforceResources"),", for example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="farm.config.ts" {4-9}',title:'"farm.config.ts"',"{4-9}":!0},"export default defineConfig({\n  compilation: {\n    partialBundling: {\n      enforceResources: [\n        {\n          name: 'index',\n          test: ['.+'],\n        }\n      ]\n    },\n  },\n});\n")),(0,i.kt)("p",null,"will produce:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"./dist/\n\u251c\u2500\u2500 index.7f833381.css  # all css modules are bundled together\n\u251c\u2500\u2500 index.ba5550d9.js   # all script modules are bundled together\n\u2514\u2500\u2500 index.html\n")),(0,i.kt)("admonition",{type:"warning"},(0,i.kt)("p",{parentName:"admonition"},(0,i.kt)("inlineCode",{parentName:"p"},"enforceResources")," will ignore all Farm's internal optimization, be careful when you use it.")),(0,i.kt)("h3",{id:"configuring-immutable-modules"},"Configuring ",(0,i.kt)("inlineCode",{parentName:"h3"},"immutable modules")),(0,i.kt)("p",null,"Using ",(0,i.kt)("inlineCode",{parentName:"p"},"immutableModules")," to configure immutable modules, by default, Farm set it to ",(0,i.kt)("inlineCode",{parentName:"p"},"node_modules/"),"."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="farm.config.ts"',title:'"farm.config.ts"'},"export default defineConfig({\n  compilation: {\n    partialBundling: {\n      immutableModules: ['node_modules/', '/global-constants']\n    },\n  },\n});\n")),(0,i.kt)("p",null,"Immutable module can affect bundling and incoming persistent cache, be careful if you want to change it."))}p.isMDXComponent=!0}}]);